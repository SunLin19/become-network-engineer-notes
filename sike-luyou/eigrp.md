# EIGRP

我在学习协议时的感受：因为协议其本身的复杂，一直看下去，查询资料“了解”之后，发现回过头来问这个问题：协议的目的是什么？是为了解决什么问题？却无法作答。因此，特意将《趣学CCNA路由与交换》这段话摘抄下来。

**我们使用路由协议的目的是让路由器正确地转发数据包**。转发的标准是路径越短越好，因此路由协议必须包含某种计算最短路径的算法。

> 摘自 《趣学CCNA路由与交换》

EIGRP是一种**高级**距离矢量路由协议（也称混合型路由协议），英语：Enhanced Interior Gateway Routing Protocol，缩写为EIGRP，因此又被译为加强型网关间选径协议。

## 高级的体现

* 采用弥散更新算法的方式计算最短路由<sup>①</sup>
* 采用更有针对性的触发更新路由
* 有效可靠的路由传输通信策略

EIGRP没有使用传输层的TCP协议或UDP协议，而是使用的是一种叫做 **可靠传输协议（RTP）** 来确保传输的可靠性。只看字面意思就可靠？那其原理是什么？（求证）

### EIGRP运作方式

**EIGRP路由器先要成为邻居，才有可能交换路由信息。** 而这个确认邻居的要素就是，**周期性的发送hello数据包**。hello包内含有监测路由超时的计时器，用于判定路由器是否失效。

**EIGRP发送hello频率（触发更新）** 比rip发送周期路由更新频率高，而且更新快，由此EIGRP路由器的网络收敛时间比RIP要快很多；又因为hello包的负载远远小于RIP包的数据负载，因此EIGRP通信效率也比RIP要更高。

EIGRP路由器了解自己相邻的设备。每当EIGRP使用组播地址244.0.0.10发送组播数据包时，**它就会维护一张应答表（记录邻居的关系表）**。如果其中存在有设备没应答，它就已单播的形式分别向这些设备重发相同的信息，如果16次后依然没响应，EIGRP就会宣告该设备失效。**除了路由表、关系表之外，还维护邻居通告各个目的网络路由信息的拓扑表**。

弥散更新算法容纳了**防环机制，无需水平分割<sup>②</sup>、路由毒化特性<sup>③</sup>；** 更重要的事弥散更新算法可以在当前路径失效时，快速收敛出新路径。

最后，**EIGRP支持等价负载均衡和不等价负载均衡**<sup>④</sup>，也就是可以将数据流量以相同比例交由度量值相同的链路，同时进行发送，或以不同比例交给度量值不同的链路同时发送。


## EIGRP的扩散更新算法（DUAL）

* 被通告距离（Advertised Distance）：这台路由器的邻居到目的网络的度量值（metric）
* 可行距离（Feasible Distance）：这台路由器自己到目的网络的度量值
* 后继路由（Successor）：这台路由器到达目的网络的下一跳路由器
* 可行后继路由（Feasible Successor）：这台路由器到达目的网络的备胎

### 防环机制

如图同理，FD=AD+该路由器到这个邻居路由器的度量值。R1走R3去往10.1.1.0/24的FD值为70，显然R2是R1去往该目的地的后继路由器（successor）。

![](https://i.postimg.cc/gk0XqWGH/2019-10-19-083931.png)

备胎限定要求：R3通告给R1的10.1.1.0/24这条路由，(20+30)已经大于R1去R2往10.1.1.0/24的FD值(40)。大凡这种情形，通告路由的这台设备(R3)就不会成为被通告设备(R1)的可行后继路由器(FS)。EIGRP不允许路由器“滥情”的理由，正是为了防止路由环路。

![](https://i.postimg.cc/XvG4Vn9x/931.png)

> 参考自 [wiki-增强型内部网关路由协议](https://zh.wikipedia.org/wiki/%E5%8A%A0%E5%BC%B7%E5%9E%8B%E9%96%98%E9%81%93%E9%96%93%E9%81%B8%E5%BE%91%E5%8D%94%E5%AE%9A)、《趣学CCNA路由与交换》

### EIGRP度量值计算公式

* EIGRP其实是IGRP的升级增强的版本，EIGRP 与IGRP可以自动互相兼容，转换因子是256
* EIGRP度量值的计算公式为：
    * `EIGRP度量值 = IGRP的度量值*256`
    * `256*{K1（10^7/带宽）+K2（10^7/带宽）/（256-负载）+K3（延迟）/10+K5/(可靠性+K4)}`
* 默认情况下，**K1和K3是1，其他的K值都是0**，所以通常情况下，**度量值=256×（10^7/最小带宽+累积延时/10）**

例：
* 经过的链路最小带宽为10000 Kbit/sec，经过两跳的累积延时为5000+1000=6000usec
* 则度量值=256×（10^7/最小带宽+累积延时/10）=256×（10^7/10000+6000/10）=409600

> 摘抄自 [百度百科-EIGRP度量值](https://baike.baidu.com/item/EIGRP%E5%BA%A6%E9%87%8F%E5%80%BC)、 并参考 [什么是A值，B值，C值，D值，K值？](https://jingyan.baidu.com/article/e73e26c099304524adb6a705.html)

注：

① Cisco系列技术和认证固然需要读者对相关算法的理论有所了解，但了解程度最多不超过应用级别，不包含对算法进行推导、计算、演绎、甚至设计，CCIE认证也概莫能外。

② 水平分割：它的规则和原理是路由器从某个接口接收到的更新信息不允许再从这个接口发回去。

③ 路由毒化：A发现自己所连的某个网段Down后，将自己关于那个网段的路由信息“毒化”，在路由表中表示为“initify”同时，向相邻路有器发送“触发更新”。

④ 负载均衡：负载平衡是一种计算机技术，用来在多个计算机（计算机集群）、网络连接、CPU、磁盘驱动器或其他资源中分配负载，以达到最优化资源使用、最大化吞吐率、最小化响应时间、同时避免过载的目的。 
