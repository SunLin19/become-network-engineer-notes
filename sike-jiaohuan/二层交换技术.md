# 二层交换技术

## 交换机的运作过程

首先交换机根据收到数据帧中的源MAC地址建立该地址同交换机端口的映射，并将其写入MAC地址表中。然后交换机将数据帧中的目的MAC地址同已建立的MAC地址表进行比较，以决定由哪个端口进行转发。若是数据帧中的目的MAC地址不在MAC地址表中，则向所有端口转发这一事件被称为泛洪（flood）。

也可手工添加交换机的MAC地址表的静态记录，手工配置没有老化时间的限制。由于MAC地址表中对于同一个MAC地址只能有一条记录，所以如果手工配置了MAC地址和端口号对应关系后，交换机就不再动态学习这台计算机的MAC地址了。

> 摘抄自 [电子发烧友-交换机的启动过程及运作原理](http://www.elecfans.com/instrument/579650_a.html)

## 交换机转发方式

直通转发：没有接收到完整的数据包就进行转发了，所以无法进行CRC校验，也就无法进行错误检查，这个工作只能落在HOST上了。加快了转发速度，减少了延迟。对比两种交换原理，不难看出在速度上是有很大提高的。

存储转发：先将接收到的帧放入内存缓存区并进行CRC校验，确认无误后再进行转发。该过程会影响传输速度存在高延迟的现象，但它能够丢弃小于64字节和不通过CRC校验的帧，也节约了带宽资源。

片段转发：接收到64字节帧才开始进行转发，这样减少了转发出错的几率（以太帧在传输时最小帧不小于64字节）。



## 冗余

冗余指出于系统安全和可靠性等方面的考虑，人为地对一些关键部件或功能进行重复的配置。当系统发生故障时，比如某一设备发生损坏，冗余配置的部件可以作为备援，及时介入并承担故障部件的工作，由此减少系统的故障时间。冗余可以存在于不同层面，如网络冗余、服务器冗余、磁盘冗余、数据冗余等。

### 冗余环路

回顾一下之前的ARP协议的运作过程：

主机A为获得主机B的mac地址，发送arp请求包（也会将自己的mac地址告诉对方），被广播的包将被同一链路所有的主机及路由器接收解析，包中的ip地址若与主机B匹配，那么主机B就将其mac地址塞入响应包以单播的形式返回给主机A。

结合拓扑分析

![](https://i.postimg.cc/B6zwTpNX/Snipaste-2019-10-30-18-43-42.png)

SW即为交换机；SW1在接收到PC A发出的ARP请求帧后，它会做两件事：

1. 首先把PC A的MAC地址和接收接口记录在MAC地址表中
2. SW1把ARP请求（协议自身的广播形式）泛洪到除接收接口以外的所有接口（SW2的F0/0和F0/1）

而SW2在收到由SW1发来的ARP广播地址帧后也会进行再一次的泛洪。由此造成重复帧、广播风暴、[mac地址漂移](https://forum.huawei.com/enterprise/zh/thread-312929.html)等一系列连锁反应，将会致使网络设备满负荷运行进而崩溃，带来大面积网络瘫痪的灾难性后果。

## 生成树协议

STP协议的运作，简单来说就是在逻辑上断开网络的环路，防止广播风暴的产生，而一旦监测到正在使用的线路出现故障，逻辑上被断开的线路又被连同，阻塞接口被激活而恢复通信，起备份线路的作用。

* 桥ID(bridge id)：由优先值和交换机mac地址构成的一组数值，默认32768（可更改）
* 开销：
* BPDU：


STP生成树选举过程

1. 选择根网桥：先比较Root ID的优先级，若优先级一样再比较MAC地址（最小最优先）
2. 选举根端口：在每个非根交换机中选出一个链路开销最低的端口，若开销、网桥ID相同则选最低端口值
3. 选举指定端口：每台交换机选举机离下游设备最近（链路开销、网桥ID低）的端口
4. 阻塞非指定端口：落选的端口将会被逻辑上断开网络环路

> 参考 [ Mr_Bei-让你彻底理解STP的各种角色选举](https://blog.csdn.net/lycb_gz/article/details/17347189)、[孤独一刀-生成树协议原理](https://blog.csdn.net/qq_34104227/article/details/81982689)

### 生成树协议的5种状态

参考连接 https://zhidao.baidu.com/question/320550807.html


